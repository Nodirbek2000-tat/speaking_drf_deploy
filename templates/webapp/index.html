<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f0f13">
<title>Speaking Bot</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0f0f13; color: #f1f5f9; font-family: system-ui, sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
.loader { text-align: center; padding: 24px; }
.logo { font-size: 64px; margin-bottom: 16px; }
.title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
.subtitle { color: #64748b; font-size: 14px; margin-bottom: 32px; }
.spinner { width: 40px; height: 40px; border: 3px solid #242430; border-top-color: #6366f1; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.error { color: #ef4444; font-size: 14px; margin-top: 20px; display: none; line-height: 1.5; }
.open-bot-btn {
  display: none; margin-top: 16px;
  background: #6366f1; color: white; border: none;
  padding: 14px 32px; border-radius: 14px;
  font-size: 16px; font-weight: 600; cursor: pointer;
}
.open-bot-btn:active { background: #4f46e5; }
.dev-btn {
  display: none; margin-top: 12px;
  background: #374151; color: #9ca3af; border: 1px solid #4b5563;
  padding: 10px 24px; border-radius: 10px;
  font-size: 13px; cursor: pointer;
}
</style>
</head>
<body>
<div class="loader">
  <div class="logo">üé§</div>
  <div class="title">Speaking Bot</div>
  <div class="subtitle">Practice English speaking daily</div>
  <div class="spinner" id="spinner"></div>
  <div class="error" id="error">
    Please open this app via the Telegram bot.<br>
    <span style="color:#64748b;font-size:12px">Open @SpeakingBot ‚Üí tap the button</span>
  </div>
  {% if debug %}
  <button class="dev-btn" id="devBtn" onclick="devLogin()">‚öôÔ∏è Dev Login (DEBUG)</button>
  {% endif %}
</div>

<script>
async function authenticate(initData) {
  const resp = await fetch('/webapp/auth/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ initData }),
    credentials: 'same-origin',
  });
  return resp.json();
}

async function init() {
  try {
    if (window.Telegram && window.Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      const initData = Telegram.WebApp.initData;
      if (initData) {
        const result = await authenticate(initData);
        if (result.ok) {
          window.location.href = result.redirect;
          return;
        }
      }
    }
  } catch (e) {
    console.error('Auth error:', e);
  }
  // Auth failed
  document.getElementById('spinner').style.display = 'none';
  document.getElementById('error').style.display = 'block';
  {% if debug %}
  document.getElementById('devBtn').style.display = 'inline-block';
  {% endif %}
}

{% if debug %}
async function devLogin() {
  const result = await authenticate('test');
  if (result.ok) {
    window.location.href = result.redirect;
  } else {
    alert('Dev login failed: ' + (result.error || 'Unknown error'));
  }
}
{% endif %}

init();
</script>
</body>
</html>
